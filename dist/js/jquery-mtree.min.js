!function(e,t,i){function n(t,i,n){this.element=t,this.settings=e.extend({},l,n),this.jsonTree=i instanceof Array?function(e,t){var n={};return n[e.identify_field]="mtree_root_"+t,n[e.child_field]=i,n}(this.settings,this.element.id):i,this.init()}var s="mtree",l={title:"",identify_field:"id",display_field:"name",child_field:"childs",addition_field:"",addition_field_default:"",addition_field_suffix:"",theme:"blue",close_same_level:!0,collapsed:!0,selected:"",link_to:"",switch_button:!0,editable:!1,context_menu:["rename","delete","insert","add"],custom_context_menu:[],search_box:!1,duration:300,delay:100,callback:e.noop};n.prototype={name:s,version:"v1.0",defaults:l,settings:null,element:null,$treeBody:null,jsonTree:{},insertPos:{append:"append",prepend:"prepend",before:"before",after:"after"},OPERATION:{NEW:0,RENAME:1,DELETE:2,SELECT:3},contextMenuOpts:{name:"treeEdit",offsetX:2,offsetY:2,textLimit:10,beforeShow:e.noop,afterShow:e.noop},menuItems:[],init:function(){var t,i,n,s,a,l,d,r=this,o=r.settings;if(t=e(this.element).addClass(this.settings.theme),t.empty(),s=this.$treeBody=e('<ul class="mtree"/>'),this.buildNodes(s,this.jsonTree[o.child_field],this.settings),this.settings.title&&(i=e("<p />").addClass("mtree-title").text(this.settings.title).appendTo(t),this.settings.switch_button&&(n=e('<span class="mtree-title-close"/>').text("×").appendTo(i),i.bind("click",function(i){var a=i.target||i.srcElement;e(a).hasClass("mtree-title-close")&&(s.is(":hidden")?(s.show(200),t.find(".mtree-search").show(200),n.text("×")):(s.hide(200),t.find(".mtree-search").hide(200),n.text("≡")))}))),o.search_box&&(a=e('<div class="mtree-search"/>').appendTo(t),l=e('<input class="mtree-search-box"/>').appendTo(a),d=e('<span class="mtree-search-btn"/>').appendTo(a),l.bind("keydown",function(e){13==e.which&&r.searchNodeInEle(this.value)}),d.bind("click",function(){r.searchNodeInEle(l.val())})),t.append(s),r.initTreeStyle(),r.bindOperation(),o.selected&&(s.data("init-select",!0),r.select(o.selected,s,o)),o.editable){for(var c=[],h={rename:{text:"重命名",func:function(){r.renameNode(this)}},deleteNode:{text:"删除",func:function(){r.deleteNode(this)}},addChild:{text:"新建",func:function(){r.insertNode(this,r.insertPos.append)}},insertBefore:{text:"插入",func:function(){r.insertNode(this,r.insertPos.before)}}},f=0;f<r.settings.context_menu.length;f++)switch(r.settings.context_menu[f]){case"rename":c.push(h.rename);break;case"delete":c.push(h.deleteNode);break;case"insert":c.push(h.insertBefore);break;case"add":c.push(h.addChild)}r.menuItems=[],r.menuItems.push(c),o.custom_context_menu.length>0&&(r.menuItems=r.menuItems.concat(o.custom_context_menu)),r.contextMenu()}},initTreeStyle:function(){var t=this,i=t.$treeBody,n=t.settings,s=null;i.length&&(n.close_same_level&&(n.collapsed=!0),i.find("ul").css({overflow:"hidden",display:n.collapsed?"none":"block"}),s=i.find("li:has(ul)"),s.each(function(){e(this).addClass("mtree-node mtree-"+(n.collapsed?"closed":"open")),e(this).children("ul").addClass("mtree-level-"+(e(this).parentsUntil(i,"ul").length+1))}))},bindOperation:function(){var t=this,n=t.$treeBody,s=t.settings,a=n.find("li:has(ul)");n.length&&(a.children("a:first-child").bind("click",function(i){var n=e(this).parent().children("ul").first(),a=e(this).parent().hasClass("mtree-open"),l=e(this).parent().hasClass("mtree-active");a&&!l||(t.setNodeClass(e(this).parent(),a),n.slideToggle(s.duration))}),n.find("li > a:first-child").bind("click",function(a){var l,d,r,o,c,h=null,f=this,u=e(this).parent().hasClass("mtree-active");if(d=e(this).data("operation"),d=d==i?t.OPERATION.SELECT:d,!u||d!=t.OPERATION.SELECT){if(d==t.OPERATION.NEW){if(o=e(this).closest("ul").parent(),o.attr("id")==n.parent().attr("id")?c={data:t.jsonTree}:(r=o.children("a:first"),c=t.getObjById(t.jsonTree,r.attr("id"),s)),!(c instanceof Object))throw new Error("not find selected node's parent node.");h={parent:c.data,data:null,index:e(this).data("index"),text:e(this).text()}}else d==t.OPERATION.RENAME?(h=t.getObjById(t.jsonTree,e(this).attr("id"),s),h.text=e(this).text()):h=t.getObjById(t.jsonTree,e(this).attr("id"),s);var p=function(e){h.parent[s.child_field].splice(h.index,0,e),t.modifyNode.call(f,e,s)},m=!1;if(n.data("init-select"))n.removeData("init-select");else if(m=s.callback.call(this,h,d,p))d==t.OPERATION.NEW||d==t.OPERATION.RENAME&&(h.data[s.display_field]=h.text);else if(d==t.OPERATION.NEW){var v=e(this).parent();v.closest("ul").children("li").length>1?v.remove():(v.closest("ul").parent().removeClass("mtree-node").removeClass("mtree-open").removeClass("mtree-close"),v.closest("ul").remove())}else d==t.OPERATION.RENAME&&e(this).text(e(this).data("text"));e(this).removeData("operation"),e(this).removeData("index"),e(this).removeData("text")}s.close_same_level&&!u&&(l=n.find(".mtree-open").not(e(this).parents("li")),l.length&&l.children("ul").delay(s.delay).slideToggle(s.duration,function(){t.setNodeClass(l,!0)})),e(this).parent().addClass("mtree-active"),n.find(".mtree-active").not(e(this).parent()).removeClass("mtree-active")}))},unbindOperation:function(){var e=this,t=e.$treeBody,i=t.find("li:has(ul)");i.children("a:first-child").unbind("click"),t.find("li > a:first-child").unbind("click")},setNodeClass:function(e,t){t?e.removeClass("mtree-open").addClass("mtree-closed"):e.removeClass("mtree-closed").addClass("mtree-open")},buildNodes:function(t,i,n){var s=arguments.callee;return e.each(i,function(i,a){var l=e("<li/>").appendTo(t),d=e("<a/>").text(a[n.display_field]).attr("href",n.link_to?n.link_to.replace(/__id__/,a[n.identify_field]):"javascript:void(0);").attr("id",a[n.identify_field]).appendTo(l);if(n.addition_field&&d.append(e('<span class="node-data-num"/>').text((a[n.addition_field]||n.addition_field_default)+(a[n.addition_field_suffix]||""))),a[n.child_field]&&a[n.child_field].length>0){var r=e("<ul/>").appendTo(l);s(r,a[n.child_field],n)}}),t},searchNodeInEle:function(e){var t=this,i=t.$treeBody;if(e){var n,s=t.settings,a=t.getEleByInnerText(i,e);if(a.length>0){t.showInfo(i,"共搜索到"+a.length+"个节点"),n=s.close_same_level?1:a.length;for(var l=0;l<n;l++)t.selectEle(a[l],s)}else t.showInfo(i,"没有找到同名节点")}else t.showInfo(i,"查询内容不能为空")},searchNodeInJson:function(e){if(e){var t,i,n,s=this,a=s.$treeBody,l=s.settings,d=s.getObjsByText(this.jsonTree,e,l);if(d.length>0){s.showInfo(a,"共搜索到"+d.length+"个节点"),i=l.close_same_level?1:d.length;for(var r=0;r<i;r++)t=d[r],n=t.data[l.identify_field],s.select(n,a,l)}else s.showInfo(a,"没有找到同名节点")}else s.showInfo(a,"查询内容不能为空")},select:function(e,t,i){var n,s=t.find("#"+e);if(s.length)return n=s.parent("li"),n.parents("ul").delay(i.delay).slideDown(i.duration,function(){n.parents("ul").parent("li").addClass("mtree-open").removeClass("mtree-closed")}),s.click(),!0},selectEle:function(t,i){var n,s=e(t);if(s.length)return n=s.parent("li"),n.parents("ul").delay(i.delay).slideDown(i.duration,function(){n.parents("ul").parent("li").addClass("mtree-open").removeClass("mtree-closed")}),s.click(),!0},getEleByInnerText:function(t,i){var n,s=t.find("li>a"),a=[];return s.each(function(){n=e(this).children().remove(),e(this).text()==i&&a.push(this),n&&e(this).append(n)}),a},getObjById:function(t,i,n){var s,a=t[n.child_field],l=arguments.callee;return e.each(a,function(e,a){if(a[n.identify_field]==i)return s={data:a,parent:t,index:e},!1;if(a[n.child_field]){var d=l(a,i,n);if(d)return s=d,!1}}),s},getObjsByText:function(t,i,n){var s,a=[],l=t[n.child_field],d=arguments.callee;return e.each(l,function(l,r){if(r[n.display_field]==i&&(s={data:r,parent:t,index:l},a.push(s)),r[n.child_field]){var o=d(r,i,n);o.length>0&&e.merge(a,o)}}),a},showInfo:function(i,n){var s=e('<span class="no-result-info"/>').text(n).appendTo(i),a=e('<span class="no-result-close"/>').text("×").appendTo(s);a.bind("click",function(e){s.remove()}),s.show(200),t.setTimeout(function(){s.hide(200),t.setTimeout(function(){s.remove()},300)},1500)},contextMenu:function(){var t=this;if(!e.fn.smartMenu)throw new Error("need jquery-smartMenu.js to supply context menu.");e(t.$treeBody).find("li").smartMenu(t.menuItems,t.contextMenuOpts)},insertNode:function(t,i){var n,s,a,l,d,r,o=this,c=e("<li/>"),h=e('<input type="text"/>').attr("id","insertIpt").val("新建节点").appendTo(c);return e(t).hasClass("mtree-closed")&&o.selectEle(e(t).children("a:first"),o.settings),"append"==i?(s=e(t).children("ul").children("li").length,s>0?n=e(t).children("ul"):(n=e("<ul>").css("overflow","hidden").appendTo(t),d=e(t).closest("ul").attr("class"),r=d.indexOf("mtree-level-"),r>-1&&(l=parseInt(d.substr(r+12,1))+1,n.addClass("mtree-level-"+l))),h.data("index",s)):"before"==i&&(n=e(t),a=o.getObjById(o.jsonTree,t.firstChild.id,o.settings),a instanceof Object&&h.data("index",a.index)),n[i](c),c.smartMenu(o.menuItems,o.contextMenuOpts),h.select(),h.data("operation",o.OPERATION.NEW),h.data("trigger",t),this.initRepalceEvt(h),c},deleteNode:function(t){var i=this,n=e(t),s=i.getObjById(i.jsonTree,t.firstChild.id,i.settings),a=i.settings.callback.call(t.firstChild,s,i.OPERATION.DELETE);a&&(s.parent[i.settings.child_field].splice(s.index,1),n.closest("ul").children("li").length>1?n.remove():(n.closest("ul").parent().removeClass("mtree-node").removeClass("mtree-open").removeClass("mtree-close"),n.closest("ul").remove()))},renameNode:function(t){var i=this,n=t.firstChild,s=e(n).children().remove(),a=e('<input type="text"/>').attr("id",t.firstChild.id).val(e(n).text());e(n).replaceWith(a),a.select(),a.data("operation",i.OPERATION.RENAME),a.data("text",e(n).text()),i.initRepalceEvt(a,s)},initRepalceEvt:function(t,i){var n=this;t.bind("keypress",function(s){s.stopPropagation(),13==s.which&&(t.val().trim()?(t.unbind("keydown"),e(document).unbind("click"),n.repalceIpt2A(t,i)):(n.showInfo(n.$treeBody,"新节点名不能为空"),t.select()))}),e(document).bind("click",function(s){s.stopPropagation();var a=s.target||s.srcElement;a.id!=t.attr("id")&&(t.val().trim()?(t.unbind("keydown"),e(document).unbind("click"),n.repalceIpt2A(t,i)):(n.showInfo(n.$treeBody,"新节点名不能为空"),t.select()))})},repalceIpt2A:function(t,i){var n=this,s=t.val().trim(),a=e("<a/>").attr("id",t.attr("id")).attr("href","javascript:void(0);").text(s).append(i),l=t.data("trigger");return t.removeData("trigger"),a.data("operation",t.data("operation")),a.data("index",t.data("index")),a.data("text",t.data("text")),t.removeData("operation"),t.removeData("index"),t.replaceWith(a),i&&(e(l).addClass("mtree-node"),e(l).addClass("mtree-open"),e(l).removeClass("mtree-closed")),n.unbindOperation(),n.bindOperation(),n.selectEle(a,n.settings),a},modifyNode:function(t,i){var n=e(this);n.text(t[i.display_field]).attr("href","javascript:void(0);").attr("id",t[i.identify_field]),i.addition_field&&a.append(e('<span class="node-data-num"/>').text((t[i.addition_field]||i.addition_field_default)+(t[i.addition_field_suffix]||"")))}},e.fn[s]=function(t,i){return this.each(function(){e.data(this,"plugin_"+s,new n(this,t,i))})}}(jQuery,window);